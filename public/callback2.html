<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Callback</title>
</head>
<body>
  <h1>Authenticating...</h1>
  <script>
    const clientId = 'e766892102b04c559335509e3fa258ef'; 
    const originalUrl = localStorage.getItem("original_url");
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    if (!code) {
      redirectToAuthCodeFlow(clientId); 
    } else {
      getAccessToken(clientId, code).then(accessToken => {
        if (accessToken) {
          localStorage.setItem('spotifyAccessToken', accessToken); 
          localStorage.removeItem("original_url"); // Clear the stored URL to avoid looping
        //   window.location.href = originalUrl;
        window.location.href = `vorsside2.html?groupId=${groupId}&positions=${JSON.stringify(positions)}`;
        } else {
          console.error('No access token found');
        }
      }).catch(error => {
        console.error('Error exchanging code for token:', error);
      });
    }
    if (code) {
      // If code is present, this means the authentication worked
      //document.body.innerHTML = `<h1>Authentication Successful!</h1><p>Your authorization code is: ${code}</p>`;

      // Store the code in localStorage (optional)
      localStorage.setItem('spotifyAuthCode', code);

      // Optionally, you can do something else here, like redirecting to another page
      window.location.href = originalUrl || 'vorsside2';
    } else {
      // If no code is found, show an error message
      document.body.innerHTML = `<h1>Authentication Failed</h1><p>No authorization code found in the URL.</p>`;
    }

    async function getAccessToken(clientId, code) {
      const verifier = localStorage.getItem("verifier");

      const params = new URLSearchParams();
      params.append("client_id", clientId);
      params.append("grant_type", "authorization_code");
      params.append("code", code);
      params.append("redirect_uri", "http://127.0.0.1:5002/callback"); // Ensure this matches your Spotify app's settings
      params.append("code_verifier", verifier);

      try {
        const result = await fetch("https://accounts.spotify.com/api/token", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: params
        });

        const response = await result.json();
        if (result.ok) {
            return response.access_token; // Return the access token
        } else {
            console.error('Error retrieving access token:', response);
            return null;
        }
    } catch (error) {
        console.error('Error fetching access token:', error);
        return null;
    }
}

// Helper function for redirecting to Spotify's authorization flow
async function redirectToAuthCodeFlow(clientId) {
            const verifier = generateCodeVerifier(128);
            localStorage.setItem("verifier", verifier); // Save code verifier in localStorage

            const challenge = await generateCodeChallenge(verifier);

            const params = new URLSearchParams();
            params.append("client_id", clientId);
            params.append("response_type", "code");
            params.append("redirect_uri", "http://127.0.0.1:5002/callback");
            params.append("scope", "user-read-private user-read-email playlist-modify-public playlist-modify-private user-read-recently-played");
            params.append("code_challenge_method", "S256");
            params.append("code_challenge", challenge);

            // Redirect the user to Spotify's authorization endpoint
            window.location = `https://accounts.spotify.com/authorize?${params.toString()}`;
        }

        // Helper functions to generate code verifier and challenge
        function generateCodeVerifier(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';

            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        async function generateCodeChallenge(codeVerifier) {
            const data = new TextEncoder().encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

    // Function to fetch the user's Spotify profile using the access token
    async function fetchProfile(token) {
      const result = await fetch("https://api.spotify.com/v1/me", {
        method: "GET", 
        headers: { Authorization: `Bearer ${token}` }
      });

      return await result.json();
    }


    async function createSpotifyPlaylist(groupId) {
    console.log('createSpotifyPlaylist function called'); 
    let accessToken = localStorage.getItem('spotifyAccessToken');
    console.log('Access Token:', accessToken);
    
    if (!accessToken) {
        localStorage.setItem("pendingGroupId", groupId); // Save groupId for later use
        redirectToAuthCodeFlow(clientId); // Only call this if absolutely necessary
        return;
    }

    const playlistName = 'On Repeat Playlist';

    try {
        // Create a new playlist using the Spotify API
        const response = await fetch('https://api.spotify.com/v1/me/playlists', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: playlistName,
                public: false,
                description: 'Playlist created for the On Repeat game',
            }),
        });

        const data = await response.json();
        console.log('Spotify API Response:', data); // Log the response for debugging

        if (response.ok) {
            const playlistId = data.id;
            console.log('Playlist created successfully with ID:', playlistId);

            // Update Firestore with the new playlist ID
            const groupRef = doc(db, 'vorsGrupper', groupId);
            await updateDoc(groupRef, {
                playlistId: playlistId
            });

            console.log('Playlist ID saved to Firestore.');
            alert('Playlist created and linked to your group!');

        } else {
            console.error('Error creating playlist:', data);
            alert('There was an error creating the playlist. Please try again.');
        }
    } catch (error) {
        console.error('Error creating Spotify playlist:', error);
        alert('An error occurred while creating the playlist.');
    }
}

  </script>

  
</body>
</html>